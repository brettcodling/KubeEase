name: Build and Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v1.2.3, etc.

jobs:
  build-deb:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.38.4'
          channel: 'stable'
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev
      
      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop
      
      - name: Get Flutter dependencies
        run: flutter pub get
      
      - name: Build Flutter app
        run: flutter build linux --release
      
      - name: Extract version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
      - name: Create .deb package structure
        run: |
          mkdir -p kubeease-deb/DEBIAN
          mkdir -p kubeease-deb/opt/kube-ease
          mkdir -p kubeease-deb/usr/share/applications
          mkdir -p kubeease-deb/usr/share/icons/hicolor/512x512/apps
          mkdir -p kubeease-deb/usr/share/pixmaps
          mkdir -p kubeease-deb/usr/local/bin
      
      - name: Copy files
        run: |
          cp -r build/linux/x64/release/bundle/* kubeease-deb/opt/kube-ease/
          cp assets/icon.png kubeease-deb/usr/share/icons/hicolor/512x512/apps/kube-ease.png
          cp assets/icon.png kubeease-deb/usr/share/pixmaps/kube-ease.png
      
      - name: Create desktop file
        run: |
          cat > kubeease-deb/usr/share/applications/kube-ease.desktop << 'EOF'
          [Desktop Entry]
          Type=Application
          Name=KubeEase
          Comment=Kubernetes Cluster Manager - Visual interface for kubectl
          Exec=/opt/kube-ease/kube_ease
          Icon=kube-ease
          Terminal=false
          Categories=Development;Utility;System;
          Keywords=kubernetes;kubectl;k8s;docker;containers;
          StartupWMClass=com.kubeease.KubeEase
          EOF
      
      - name: Create control file
        run: |
          cat > kubeease-deb/DEBIAN/control << EOF
          Package: kubeease
          Version: ${{ steps.get_version.outputs.VERSION }}
          Section: utils
          Priority: optional
          Architecture: amd64
          Maintainer: Brett Codling <brettcodling94@gmail.com>
          Description: Modern Kubernetes cluster manager
           KubeEase provides an intuitive desktop interface for managing your
           Kubernetes resources with features like interactive terminals, file
           transfer, log streaming, and port forwarding.
           .
           Requires kubectl to be installed and configured.
          EOF
      
      - name: Create postinst script
        run: |
          cat > kubeease-deb/DEBIAN/postinst << EOF
          #!/bin/bash
          set -e
          ln -sf /opt/kube-ease/kube_ease /usr/local/bin/kube-ease
          chmod +x /opt/kube-ease/kube_ease
          if command -v gtk-update-icon-cache &> /dev/null; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor || true
          fi
          if command -v update-desktop-database &> /dev/null; then
            update-desktop-database /usr/share/applications || true
          fi
          if ! command -v kubectl &> /dev/null; then
            echo "WARNING: kubectl is not installed or not in PATH"
            echo "KubeEase requires kubectl to function properly"
            echo "Please install kubectl: https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/"
          fi
          EOF

      - name: Create postrm script
        run: |
          cat > kubeease-deb/DEBIAN/postrm << EOF
          #!/bin/bash
          set -e
          rm -f /usr/local/bin/kube-ease
          if command -v gtk-update-icon-cache &> /dev/null; then
            gtk-update-icon-cache -f -t /usr/share/icons/hicolor || true
          fi
          if command -v update-desktop-database &> /dev/null; then
            update-desktop-database /usr/share/applications || true
          fi
          EOF
      
      - name: Build .deb package
        run: |
          dpkg-deb --build kubeease-deb
          mv kubeease-deb.deb kubeease_${{ steps.get_version.outputs.VERSION }}_amd64.deb
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          draft: false
          prerelease: false
          body: |
            ## KubeEase ${{ steps.get_version.outputs.VERSION }}
            
            ### Installation
            
            Download the `.deb` file below and install:
            ```bash
            sudo dpkg -i kubeease_${{ steps.get_version.outputs.VERSION }}_amd64.deb
            ```
            
            ### Requirements
            - kubectl must be installed and configured
            - Ubuntu 20.04 or later (or compatible Debian-based distribution)
            
            ### What's Changed
            - See [User Guide](https://github.com/brettcodling/KubeEase/blob/main/USER_GUIDE.md) for full documentation
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./kubeease_${{ steps.get_version.outputs.VERSION }}_amd64.deb
          asset_name: kubeease_${{ steps.get_version.outputs.VERSION }}_amd64.deb
          asset_content_type: application/vnd.debian.binary-package
